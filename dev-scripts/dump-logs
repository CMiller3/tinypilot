#!/bin/bash

# Exit on unset variable.
set -u

LOG_FILE=$(mktemp)
echo "Writing diagnostic logs to $LOG_FILE"

echo "Checking TinyPilot version..."
cd /opt/tinypilot
echo "TinyPilot version" >> "$LOG_FILE"
git rev-parse HEAD >> "$LOG_FILE"
echo "\n" >> "$LOG_FILE"

echo "Checking uStreamer version..."
cd /opt/ustreamer
echo "uStreamer version" >> "$LOG_FILE"
git rev-parse HEAD >> "$LOG_FILE"
echo "\n" >> "$LOG_FILE"

echo "Checking TinyPilot logs..."
echo "TinyPilot logs" >> "$LOG_FILE"
sudo journalctl -u tinypilot >> "$LOG_FILE"

echo "Checking uStreamer logs..."
echo "uStreamer logs" >> "$LOG_FILE"
sudo journalctl -u ustreamer >> "$LOG_FILE"

echo "Checking nginx logs..."
echo "nginx logs" >> "$LOG_FILE"
sudo journalctl -u nginx >> "$LOG_FILE"
sudo tail -n 100 /var/log/nginx/error.log >> "$LOG_FILE"

echo "Full logs"
cat "$LOG_FILE"
echo "\n\n"

echo -n "Upload your log file (y/n)? "
read answer
if [ "$answer" != "${answer#[Yy]}" ] ;then
    cat "$LOG_FILE" | curl -F 'sprunge=<-' http://sprunge.us
else
    echo No
fi
